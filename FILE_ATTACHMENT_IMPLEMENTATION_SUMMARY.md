# File Attachment Implementation Summary

## Overview
This document provides a summary of the file attachment implementation in the CRA Backend system. The implementation allows users to attach files to solicitations with proper access control.

## New Implementation (SoliArquivo)
The new implementation uses a simplified approach with the following components:

### Entities
1. **SoliArquivo**: Represents file attachments with the following fields:
   - id: Primary key
   - solicitacao: Reference to the associated solicitation
   - nomearquivo: Name of the uploaded file
   - datainclusao: Timestamp when the file was uploaded
   - caminhofisico: Physical path where the file is stored
   - origem: Source of the file (e.g., "correspondente" or "usuario")
   - ativo: Boolean flag indicating if the file is active
   - caminhorelativo: Relative HTTP path to access the file

2. **Solicitacao**: Updated to include a one-to-many relationship with SoliArquivo

### Repositories
1. **SoliArquivoRepository**: JPA repository for managing file attachments

### Services
1. **SoliArquivoService**: Business logic for handling file operations including:
   - File upload with unique naming (UUID + original filename)
   - File storage in configurable directory
   - Access control (correspondents can only delete their own files)
   - File retrieval and deletion

### Controllers
1. **SoliArquivoController**: REST endpoints for file attachment operations:
   - POST /api/soli-arquivos/upload: Upload a new file attachment
   - GET /api/soli-arquivos/solicitacao/{solicitacaoId}: Get all files for a solicitation
   - GET /api/soli-arquivos/{id}: Get a specific file by ID
   - PUT /api/soli-arquivos/{id}: Update file information
   - DELETE /api/soli-arquivos/{id}: Delete a file (with access control)

### Tests
1. **SoliArquivoServiceTest**: Unit tests for the file attachment service
2. **SoliArquivoControllerTest**: Unit tests for the file attachment controller

## Removed Components
The following components from the old implementation have been removed as they are no longer needed:

1. **SolicitacaoPossuiArquivo**: The many-to-many relationship entity
2. **SolicitacaoPossuiArquivoId**: The composite key class for the relationship entity
3. **SolicitacaoPossuiArquivoRepository**: The repository for managing relationships

These components were part of a more complex implementation that used a many-to-many relationship between solicitations and file attachments. The new implementation uses a simpler one-to-many relationship where each file attachment belongs to exactly one solicitation.

## File Naming Convention
Files are stored with a unique name generated by combining a UUID with the original filename to ensure:
- Uniqueness across all uploaded files
- Preservation of the original filename for identification
- Compatibility with file system limitations

The naming pattern is: `{UUID}_{original_filename}`

For example, if a user uploads a file named "document.pdf", it will be stored as something like:
`550e8400-e29b-41d4-a716-446655440000_document.pdf`

## Configuration
The file storage directory is configured in `application.properties`:
```
file.upload-dir=D:\Projetos\craweb\arquivos
```

## Access Control
The implementation includes access control logic where:
- Correspondents can only delete files they uploaded
- Administrators and other users can delete any file

This is implemented in the `podeDeletar` method in `SoliArquivoService`.