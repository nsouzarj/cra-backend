# File Attachment API

## Overview
This document describes the file attachment functionality in the CRA Backend system. The API allows users to attach files to solicitations with proper access control and selective storage options (local or Google Drive).

## New Implementation (SoliArquivo)

### SoliArquivo
The new implementation uses a simplified approach with the SoliArquivo entity:

#### Fields
- `id` (Long): Primary key
- `solicitacao` (Solicitacao): Reference to the associated solicitation
- `nomearquivo` (String): Name of the uploaded file
- `datainclusao` (LocalDateTime): Timestamp when the file was uploaded
- `caminhofisico` (String): Physical path where the file is stored (local storage only)
- `origem` (String): Source of the file (e.g., "correspondente" or "usuario")
- `ativo` (boolean): Boolean flag indicating if the file is active
- `caminhorelativo` (String): Relative HTTP path to access the file (local storage only)
- `storageLocation` (String): Where the file is stored ("local" or "google_drive")
- `googleDriveFileId` (String): Google Drive file ID (when stored in Google Drive)
- `userId` (Long): ID of the user who owns the file (for Google Drive access)

### SoliArquivoRepository
JPA repository for managing SoliArquivo entities with the following methods:
- Standard CRUD operations inherited from JpaRepository
- `findBySolicitacao(Solicitacao solicitacao)`: Find all files for a solicitation
- `findBySolicitacaoIdsolicitacao(Long idSolicitacao)`: Find all files for a solicitation by ID

### SoliArquivoService
Business logic for handling file operations including:

#### Methods
- `salvarAnexo(MultipartFile file, Long solicitacaoId, String origem, String storageLocation, Long userId)`: Save a new file attachment with UUID + original filename naming
- `listarAnexosPorSolicitacao(Long solicitacaoId)`: Get all files for a solicitation
- `buscarPorId(Long id)`: Get a specific file by ID
- `atualizar(Long id, SoliArquivo soliArquivo)`: Update file information
- `deletar(Long id)`: Delete a file
- `podeDeletar(Long id, String origem)`: Check if a file can be deleted by a specific origin
- `getFileContent(Long id, Long userId)`: Get file content as InputStream from either local storage or Google Drive

### SoliArquivoController
REST endpoints for file attachment operations:

#### Endpoints
- `POST /api/soli-arquivos/upload`: Upload a new file attachment
  - Parameters:
    - `file` (MultipartFile): The file to upload
    - `solicitacaoId` (Long): The ID of the solicitation to attach the file to
    - `origem` (String, optional): The origin of the file (default: "usuario")
    - `storageLocation` (String, optional): Where to store the file ("local" or "google_drive", default: "local")
    - `userId` (Long, optional): The ID of the user uploading the file (required for Google Drive storage)
  - Response: Created SoliArquivoDTO

- `GET /api/soli-arquivos/solicitacao/{solicitacaoId}`: Get all files for a solicitation
  - Parameters:
    - `solicitacaoId` (Long): The ID of the solicitation
  - Response: List of SoliArquivoDTO

- `GET /api/soli-arquivos/{id}`: Get a specific file by ID
  - Parameters:
    - `id` (Long): The ID of the file
  - Response: SoliArquivoDTO

- `GET /api/soli-arquivos/{id}/download`: Download a specific file
  - Parameters:
    - `id` (Long): The ID of the file
    - `userId` (Long, optional): The ID of the user requesting the download (required for Google Drive files)
  - Response: File content as downloadable resource

- `PUT /api/soli-arquivos/{id}`: Update file information
  - Parameters:
    - `id` (Long): The ID of the file
    - `dto` (SoliArquivoDTO): The updated file information
  - Response: Updated SoliArquivoDTO

- `DELETE /api/soli-arquivos/{id}`: Delete a file (with access control)
  - Parameters:
    - `id` (Long): The ID of the file
    - `origem` (String, optional): The origin trying to delete the file (default: "usuario")
  - Response: 204 No Content

### File Naming Convention
Files are stored with a unique name generated by combining a UUID with the original filename to ensure:
- Uniqueness across all uploaded files
- Preservation of the original filename for identification
- Compatibility with file system limitations

The naming pattern is: `{UUID}_{original_filename}`

For example, if a user uploads a file named "document.pdf", it will be stored as something like:
`550e8400-e29b-41d4-a716-446655440000_document.pdf`

### SoliArquivoDTO
Data Transfer Object for API responses containing:
- `id` (Long): Primary key
- `idSolicitacao` (Long): ID of the associated solicitation
- `nomearquivo` (String): Name of the uploaded file
- `dataInclusao` (LocalDateTime): Timestamp when the file was uploaded
- `origem` (String): Source of the file
- `ativo` (boolean): Active status
- `caminhoRelativo` (String): Relative HTTP path to access the file
- `storageLocation` (String): Where the file is stored ("local" or "google_drive")
- `googleDriveFileId` (String): Google Drive file ID (when stored in Google Drive)
- `userId` (Long): ID of the user who owns the file (for Google Drive access)

## Google Drive Integration API

### GoogleDriveController
REST endpoints for managing Google Drive OAuth2 flow:

#### Endpoints
- `GET /api/google-drive/authorize`: Initiate Google Drive OAuth flow
  - Parameters:
    - `userId` (Long): The ID of the user connecting their Google Drive
  - Response: Redirect to Google OAuth2 consent screen

- `GET /api/google-drive/callback`: Handle OAuth callback
  - Parameters:
    - `code` (String): The authorization code from Google
    - `state` (String): The user ID passed in the state parameter
  - Response: Success or error message

- `GET /api/google-drive/status`: Check Google Drive connection status
  - Parameters:
    - `userId` (Long): The ID of the user
  - Response: Connection status

- `DELETE /api/google-drive/disconnect`: Disconnect Google Drive
  - Parameters:
    - `userId` (Long): The ID of the user
  - Response: Success or error message

## API Usage Examples

### Upload a File to Local Storage
```bash
curl -X POST \
  http://localhost:8081/cra-api/api/soli-arquivos/upload \
  -H 'content-type: multipart/form-data' \
  -F 'file=@/path/to/file.pdf' \
  -F 'solicitacaoId=123' \
  -F 'origem=correspondente'
```

### Upload a File to Google Drive
```bash
curl -X POST \
  http://localhost:8081/cra-api/api/soli-arquivos/upload \
  -H 'content-type: multipart/form-data' \
  -F 'file=@/path/to/file.pdf' \
  -F 'solicitacaoId=123' \
  -F 'origem=correspondente' \
  -F 'storageLocation=google_drive' \
  -F 'userId=456'
```

### List Files for a Solicitation
```bash
curl -X GET \
  http://localhost:8081/cra-api/api/soli-arquivos/solicitacao/123
```

### Get a Specific File
```bash
curl -X GET \
  http://localhost:8081/cra-api/api/soli-arquivos/456
```

### Download a File from Local Storage
```bash
curl -X GET \
  http://localhost:8081/cra-api/api/soli-arquivos/456/download
```

### Download a File from Google Drive
```bash
curl -X GET \
  http://localhost:8081/cra-api/api/soli-arquivos/456/download?userId=789
```

### Update File Information
```bash
curl -X PUT \
  http://localhost:8081/cra-api/api/soli-arquivos/456 \
  -H 'content-type: application/json' \
  -d '{
    "id": 456,
    "idSolicitacao": 123,
    "nomearquivo": "updated-file.pdf",
    "origem": "usuario",
    "ativo": true,
    "caminhoRelativo": "/arquivos/updated-file.pdf",
    "storageLocation": "local",
    "userId": 789
  }'
```

### Delete a File
```bash
curl -X DELETE \
  http://localhost:8081/cra-api/api/soli-arquivos/456?origem=correspondente
```

### Connect Google Drive Account
```bash
curl -X GET \
  http://localhost:8081/cra-api/api/google-drive/authorize?userId=456
```

### Check Google Drive Connection Status
```bash
curl -X GET \
  http://localhost:8081/cra-api/api/google-drive/status?userId=456
```

### Disconnect Google Drive Account
```bash
curl -X DELETE \
  http://localhost:8081/cra-api/api/google-drive/disconnect?userId=456
```

## Access Control
The implementation includes access control logic where:
- Correspondents can only delete files they uploaded
- Administrators and other users can delete any file

This is implemented in the `podeDeletar` method in `SoliArquivoService`.

## Selective Storage
The implementation supports selective storage where:
- Files can be stored locally or in Google Drive
- Storage location is selected at upload time
- Both storage options work seamlessly with the same API

## Configuration
The file storage directory is configured in `application.properties`:
```
file.upload-dir=D:\Projetos\craweb\arquivos
```

Google Drive OAuth configuration:
```
google.drive.oauth.enabled=true
google.drive.oauth.client.id=your-client-id
google.drive.oauth.client.secret=your-client-secret
google.drive.folder.id=optional-folder-id
google.drive.oauth.redirect.uri=http://localhost:8081/cra-api/api/google-drive/callback
```